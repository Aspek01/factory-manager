# D-0.2 — RBAC & Scope Binding (MVP — LOCKED)

## 1) Purpose
Kullanıcı rol yönetimi ve scope bağlama (SYSTEM/COMPANY/FACILITY/SECTION/WORKSTATION) kurallarını kilitlemek.
Amaç: multi-tenant izolasyonu bozmadan doğru yetkilendirme sınırlarını deterministik hale getirmek.

## 2) Roles (LOCKED)
1) system_admin (SYSTEM)
2) company_manager (COMPANY)
3) sales_engineer (COMPANY)
4) production_engineer (FACILITY)
5) planner (FACILITY)
6) purchasing (FACILITY)
7) goods_receipt_clerk (FACILITY)
8) section_supervisor (SECTION)
9) quality_inspector (FACILITY)
10) operator (WORKSTATION)

## 3) User ↔ Company Binding (LOCKED)
- system_admin hariç her kullanıcı tam olarak 1 company’ye bağlıdır.
- Multi-company user (aynı user birden fazla company) MVP dışı.
- Kullanıcı login olduktan sonra active_company_id zorunludur.
- Kullanıcı company bağından farklı bir company için request yapamaz (403).

## 4) Scope Binding Rules (LOCKED)
Her user için "primary scope" tutulur:
- system_admin: SYSTEM (company seçebilir)
- company_manager: COMPANY
- sales_engineer: COMPANY
- production_engineer: FACILITY
- planner: FACILITY
- purchasing: FACILITY
- goods_receipt_clerk: FACILITY
- quality_inspector: FACILITY
- section_supervisor: SECTION
- operator: WORKSTATION

Ek kurallar:
- FACILITY scope rolleri facility_id ile bağlanır.
- SECTION scope rolleri section_id ile bağlanır (implied facility).
- WORKSTATION scope rolleri workstation_id ile bağlanır (implied section/facility).
- Üst scope alt scope'u okuyabilir (sadece ihtiyaç olan ekranlarda).
- Alt scope üst scope'u asla göremez.

## 5) Active Scope Resolution (LOCKED)
Request context alanları:
- active_company_id (mandatory)
- active_facility_id (optional)
- active_section_id (optional)
- active_workstation_id (optional)

Çözümleme:
- system_admin: active_company_id seçebilir (UI üzerinden). Diğer scope alanları opsiyonel.
- company_manager / sales_engineer:
  - active_company_id sabit (kendi company)
  - facility/section/workstation filtreleme amaçlı seçilebilir; tutarlılık zorunlu.
- facility-scope roller (PE/PL/PU/GR/QI):
  - active_company_id sabit
  - active_facility_id sabit (user binding)
  - section/workstation sadece filtre amaçlı seçilebilir; tutarlılık zorunlu.
- section_supervisor:
  - active_company_id sabit
  - active_section_id sabit (user binding)
  - active_facility_id implied
  - workstation sadece filtre amaçlı seçilebilir; section tutarlılığı zorunlu.
- operator:
  - active_company_id sabit
  - active_workstation_id sabit (user binding)
  - active_section_id + active_facility_id implied
  - operator aktif scope değiştiremez (UI’da seçim yok)

## 6) Operator Negative Visibility Rules (LOCKED)
Operator:
- Diğer workstation’ları göremez.
- Tüm work order listesini göremez.
- Sadece:
  - kendi workstation’ına atanmış operations
  - kendi queue (WorkstationQueueView)
  - kendi assigned op detayları
  - ilgili dokümanlar (Documents binding, assigned ops ile sınırlı)
  - kendi event geçmişi (limited)
görür.

## 7) Write Restrictions (Ledger & Domain) (LOCKED)
- Hiçbir rol ledger update/delete yapamaz.
- Düzeltme reverse entry ile yapılır.
- RBAC permission "edit" kavramı:
  - master data edit izinleri vardır (örn. Part, BOM) ancak ledger satırları değişmez.
  - audit log append-only.

## 8) Enforcement Points (LOCKED)
Yetkilendirme 3 katmanda zorunlu:
1) API Gateway / middleware: active_company_id + scope tutarlılık doğrulaması
2) Query layer: tüm query’lerde company_id filtresi zorunlu (default)
3) UI: role-based navigation + operator UI kısıtları

## 9) Out of Scope
- Field-level permission
- Custom role builder
- Multi-company user
- Delegation/impersonation

## 10) Acceptance Criteria
- Roller + primary scope binding net ve test edilebilir.
- Operator negatif kuralları açıkça tanımlı.
- Active scope resolution kuralları çelişkisiz.
- Bu spec kilitlenmeden RBAC kodu yazılamaz.
